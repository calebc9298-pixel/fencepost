rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && (request.auth.token.email == 'calebc9298@gmail.com' || request.auth.token.email == 'calebc9298@outlook.com');
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Allow non-owners to update only engagement counters on posts
    function isPostEngagementOnlyUpdate() {
      return isAuthenticated()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'commentCount']);
    }

    // Allow non-owners to update only engagement counters on comments
    function isCommentEngagementOnlyUpdate() {
      return isAuthenticated()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }
    
    // Users collection - users can read all, but only write their own (admin can update/delete any)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isOwner(userId) || isAdmin();
    }
    
    // Posts collection - authenticated users can read all, only owners can update/delete (admin can delete any)
    match /posts/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin() || isPostEngagementOnlyUpdate();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Comments collection - authenticated users can read all, only owners can update/delete (admin can delete any)
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin() || isCommentEngagementOnlyUpdate();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // User interactions (likes/dislikes) - users can only access their own
    match /userInteractions/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Fields - users can only access their own fields
    match /fields/{fieldId} {
      allow read, write: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
    }
    
    // Field costs - users can only access their own
    match /fieldCosts/{costId} {
      allow read, write: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
    }

    // Field harvest bushels - users can only access their own
    match /fieldHarvestBushels/{harvestId} {
      allow read, write: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
    }
    
    // Marketing revenue - users can only access their own
    match /marketingRevenue/{revenueId} {
      allow read, write: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
    }
    
    // Rainfall data - users can only access their own
    match /rainfall/{rainfallId} {
      allow read, write: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
    }
    
    // Notifications collection - users can read their own, anyone can create
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.recipientId;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && request.auth.uid == resource.data.recipientId;
      allow delete: if false;
    }
  }
}
