/*
  Creates two fresh E2E users by automating the app's Register screen.
  This ensures both Firebase Auth AND the Firestore /users profile doc exist.

  Writes credentials into .env.e2e (gitignored).
*/

const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
const dotenv = require('dotenv');
const { chromium } = require('@playwright/test');

const projectRoot = path.resolve(__dirname, '..');
const envPath = path.join(projectRoot, '.env.e2e');

if (fs.existsSync(envPath)) {
  dotenv.config({ path: envPath, override: true });
}

const baseUrl = process.env.E2E_BASE_URL || 'https://fencepost-65663.web.app';

function randomPassword(length = 18) {
  // Firebase requires >= 6 chars; we'll generate a strong ASCII password.
  return crypto
    .randomBytes(Math.ceil(length * 2))
    .toString('base64')
    .replace(/[^a-zA-Z0-9]/g, '')
    .slice(0, length);
}

function upsertEnvFile(filePath, updates) {
  const existing = fs.existsSync(filePath) ? fs.readFileSync(filePath, 'utf8') : '';
  const lines = existing.split(/\r?\n/);
  const map = new Map();

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    const eq = trimmed.indexOf('=');
    if (eq === -1) continue;
    const key = trimmed.slice(0, eq).trim();
    const value = trimmed.slice(eq + 1);
    map.set(key, value);
  }

  for (const [key, value] of Object.entries(updates)) {
    map.set(key, value);
  }

  // Keep a stable, readable order.
  const orderedKeys = [
    'E2E_BASE_URL',
    'E2E_EMAIL',
    'E2E_PASSWORD',
    'E2E_EMAIL_2',
    'E2E_PASSWORD_2',
  ];

  const output = [];
  output.push('# Auto-generated by scripts/create-e2e-users.js');
  for (const key of orderedKeys) {
    if (map.has(key)) output.push(`${key}=${map.get(key)}`);
  }

  // Preserve any extra keys from the existing file.
  for (const [key, value] of map.entries()) {
    if (orderedKeys.includes(key)) continue;
    output.push(`${key}=${value}`);
  }

  fs.writeFileSync(filePath, output.join('\n') + '\n', 'utf8');
}

async function registerUser(page, { email, password, name }) {
  await page.goto('/', { waitUntil: 'load' });

  // Wait for the app to be interactive.
  try {
    await page.locator('input[placeholder="Email"]:visible').first().waitFor({ timeout: 60_000 });
  } catch (err) {
    const outDir = path.join(projectRoot, 'test-results');
    try {
      fs.mkdirSync(outDir, { recursive: true });
      await page.screenshot({ path: path.join(outDir, 'create-e2e-users-login-missing.png'), fullPage: true });
      const html = await page.content().catch(() => '');
      fs.writeFileSync(path.join(outDir, 'create-e2e-users-login-missing.html'), html, 'utf8');
      fs.writeFileSync(path.join(outDir, 'create-e2e-users-login-missing.url.txt'), String(page.url()), 'utf8');
    } catch {
      // ignore
    }
    throw err;
  }

  // Go to Register
  const toRegister = page
    .getByText(/don't have an account\? register/i)
    .or(page.locator('[tabindex="0"]', { hasText: /register/i }).first())
    .or(page.getByText(/register/i));

  await toRegister.first().scrollIntoViewIfNeeded();
  await toRegister.first().click();

  const registerName = page.locator('input[placeholder="Full Name"]:visible').first();
  try {
    await registerName.waitFor({ timeout: 30_000 });
  } catch (err) {
    const outDir = path.join(projectRoot, 'test-results');
    try {
      fs.mkdirSync(outDir, { recursive: true });
      await page.screenshot({ path: path.join(outDir, 'create-e2e-users-failure.png'), fullPage: true });
    } catch {
      // ignore
    }
    throw err;
  }

  // Fill required fields
  await registerName.fill(name);
  await page.locator('input[placeholder="Email"]:visible').first().fill(email);
  await page.locator('input[placeholder="Password"]:visible').first().fill(password);
  await page.locator('input[placeholder="Confirm Password"]:visible').first().fill(password);

  await page.locator('input[placeholder="Street Address"]:visible').first().fill('123 Test St');
  await page.locator('input[placeholder="City"]:visible').first().fill('Testville');
  await page.locator('input[placeholder="State (e.g., IA)"]:visible').first().fill('IA');
  await page.locator('input[placeholder="Zip Code"]:visible').first().fill('50309');

  const submit = page
    .getByRole('button', { name: /^Register$/ })
    .or(page.locator('[tabindex="0"]', { hasText: /^Register$/ }).first());
  await submit.first().scrollIntoViewIfNeeded();
  await submit.first().click();

  // Successful registration signs the user in; the app should switch to the Feed.
  try {
    await page
      .locator('[placeholder="What\'s happening on the farm?"]:visible')
      .first()
      .waitFor({ timeout: 60_000 });
  } catch (err) {
    const outDir = path.join(projectRoot, 'test-results');
    try {
      fs.mkdirSync(outDir, { recursive: true });
      await page.screenshot({ path: path.join(outDir, 'create-e2e-users-after-submit.png'), fullPage: true });
    } catch {
      // ignore
    }
    throw err;
  }
}

async function main() {
  const stamp = Date.now();
  const emailA = `e2e.user.a.${stamp}@example.com`;
  const emailB = `e2e.user.b.${stamp}@example.com`;
  const passwordA = randomPassword();
  const passwordB = randomPassword();

  const browser = await chromium.launch({ headless: true });

  try {
    console.log(`Base URL: ${baseUrl}`);
    console.log('Creating two fresh E2E users via Register screen...');

    for (const user of [
      { email: emailA, password: passwordA, name: 'E2E User A' },
      { email: emailB, password: passwordB, name: 'E2E User B' },
    ]) {
      const ctx = await browser.newContext({ baseURL: baseUrl });
      const page = await ctx.newPage();
      const dialogMessages = [];

      // Auto-accept any Alert.alert() dialogs emitted by the app.
      page.on('dialog', async (dialog) => {
        dialogMessages.push(dialog.message());
        try {
          await dialog.accept();
        } catch {
          // ignore
        }
      });

      try {
        await registerUser(page, user);
      } catch (err) {
        const tail = dialogMessages.slice(-3);
        if (tail.length) {
          // Surface the app-level error if one was shown.
          throw new Error([`Failed creating user ${user.email}.`, `Recent dialogs: ${tail.join(' | ')}`, String(err?.message || err)].join('\n'));
        }
        throw err;
      } finally {
        await ctx.close();
      }
    }

    upsertEnvFile(envPath, {
      E2E_BASE_URL: baseUrl,
      E2E_EMAIL: emailA,
      E2E_PASSWORD: passwordA,
      E2E_EMAIL_2: emailB,
      E2E_PASSWORD_2: passwordB,
    });

    console.log('Done. Wrote credentials to .env.e2e (gitignored).');
    console.log(`E2E_EMAIL=${emailA}`);
    console.log(`E2E_PASSWORD=${passwordA}`);
    console.log(`E2E_EMAIL_2=${emailB}`);
    console.log(`E2E_PASSWORD_2=${passwordB}`);

  } finally {
    await browser.close();
  }
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});
